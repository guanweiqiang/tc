# 邮件异步发送 MQ 架构设计文档

> 文档类型：产品/架构设计文档（Design Doc）
> 适用场景：验证码 / 通知类邮件
> 技术栈：Spring Boot + RabbitMQ + Redis

------

## 1. 背景与问题

在用户**注册、登录、修改密码**等场景中，需要发送验证码或通知邮件。最初采用**同步发送邮件**方式，存在明显问题：

- SMTP 属于慢 I/O，请求 RT 高（约 1s）
- 邮件服务不稳定会直接影响接口可用性
- 高并发下占用 Web 线程，存在拖垮主服务风险

因此，将邮件发送从主业务链路中解耦，设计并实现 **基于 RabbitMQ 的异步邮件发送架构**。

------

## 2. 设计目标

本设计并非强一致性消息系统，目标明确如下：

1. **显著降低接口响应时间**（RT 从 ~1s 降至十几 ms）
2. **邮件最多发送一次（幂等）**
3. **发送失败可观测、可追踪（DLQ）**
4. **允许消息过期或被丢弃（验证码业务特性）**
5. **系统稳定性优先于邮件送达完整性**

------

## 3. 整体架构说明

### 3.1 架构概览（逻辑）

```
Client
  │
  │ HTTP 请求
  ▼
Web Service
  - 参数校验
  - Redis 频控 / 去重
  - 生成验证码
  - 发送 MQ 消息
  │
  ▼
Mail Exchange
  │
  ▼
Mail Queue
  - max-length = 1000
  - TTL = 60s
  - DLX
  │
  ▼
Mail Consumer
  - Redis 幂等校验
  - 发送邮件
  - ACK / NACK
  │            \
  │ ACK         \ NACK
  ▼              ▼
(结束)        Dead Letter Exchange
                  │
                  ▼
              Dead Letter Queue
```

------

## 4. MQ 资源设计

### 4.1 主资源

| 类型        | 名称                 |
| ----------- | -------------------- |
| Exchange    | exchange.direct.mail |
| Queue       | queue.mail           |
| Routing Key | mail                 |

### 4.2 主队列参数

- **TTL：60 秒**
  超过 60 秒仍未被消费的邮件消息，视为已失去业务价值，自动进入死信队列。
- **max-length：1000（drop-head）**
  防止邮件消息无限积压，队列满时丢弃最旧消息，保证系统整体稳定。
- **Dead Letter Exchange**
  用于承接失败或过期的邮件消息。

------

### 4.3 死信资源

| 类型 | 名称                      |
| ---- | ------------------------- |
| DLX  | exchange.dead-letter.mail |
| DLQ  | queue.mail.dlq            |

死信队列用于：

- 失败消息监控
- 运维排查
- 后续人工补发或扩展处理

------

## 5. Producer 设计

### 职责

- 仅负责 **发送 MQ 消息**
- 不执行任何邮件发送逻辑
- 不阻塞主业务流程

### 失败处理

- MQ 发送失败：
  - 回滚 Redis 中已生成的验证码
  - 接口返回失败提示

------

## 6. Consumer 设计

### 6.1 幂等性设计

为防止消息重复投递导致重复发送邮件，在 Consumer 侧实现幂等控制。

**幂等 Key 设计：**

```
mail:sent:mq:{email}:{code}:{purpose}
```

- 使用 Redis `SETNX + TTL`
- Key 已存在：说明该邮件已处理，直接 ACK
- Key 不存在：继续发送邮件

保证 **同一封邮件最多发送一次**。

------

### 6.2 消费流程

1. 消费 MQ 消息
2. 执行 Redis 幂等校验
3. 调用邮件发送服务
4. 成功：发送 `ACK`
5. 失败：发送 `NACK (requeue=false)`，消息进入 DLQ

------

### 6.3 失败策略

- 不进行无限重试
- 邮件发送失败直接进入死信队列
- 死信队列用于观测与补偿，不影响主业务流程

------

## 7. 系统行为语义说明

本系统的真实行为语义如下：

- 接口成功 ≠ 邮件一定送达
- 邮件最多发送一次
- 邮件可能因过期或积压被丢弃
- 邮件失败不会影响主流程
- 系统稳定性优先于通知完整性

该语义与**验证码/通知类邮件**的业务特性完全匹配。

------

## 8. 设计取舍说明

- 邮件属于弱一致性通知，不适合强事务保证
- 使用 MQ 异步解耦慢 I/O，大幅降低接口 RT
- TTL 与 max-length 是主动背压策略
- DLQ 提供失败可观测性而非无限补偿
- Redis 幂等防止重复发送

------

## 9. 可扩展方向

- 死信队列告警与监控
- 后台人工补发接口
- 延迟重试队列（TTL Retry Queue）
- 邮件优先级队列

------

## 10. 总结

该邮件异步 MQ 架构：

- 设计目标明确
- 失败边界清晰
- 工程取舍合理
- 可长期维护与演进

适用于 **高并发、弱一致性通知类业务场景**。